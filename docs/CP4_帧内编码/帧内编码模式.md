# 帧内编码模式

## 1 概述

帧内编码模式用于指示帧内编码中将**如何通过周围的邻近像素预测当前像素**，其决定了编解码器在参考像素生成、像素预测和后处理滤波中的**具体行为**。相比于 H.264，HEVC 使用了更多的帧内编码模式，亮度分量的模式达到了 **35 种**，色度分量的模式有 **5 种**。帧内编码模式在 **PU 层次**选择（也就是不同的 PU 有不同的帧内编码模式）。

!> 然而帧内编码本身是在 **TU 层次**上进行的，由于前文 [分块操作] 中提到在帧内编码情况下 CU 只能按照 2Nx2N 或者 NxN（当 CU 为最小允许值）划分 PU，因此可以保证一个 PU 中包含整数个 TU

## 2 亮度分量的帧内编码模式

### 2.1 帧内编码模式简介

HEVC 的亮度分量有 35 种帧内编码模式，分为**33 种角度模式**和 **Planar 模式**以及 **DC 模式**，每个模式有其编号，其中 Planar 模式编号为 0，DC 模式编号为 1，其余的角度模式编号为 2~34。

不同的帧内编码模式适用于不同的场合，角度模式用于**像素具有纹理变化**的区块，Planar 模式适用于**像素颜色缓慢渐变**的区块，DC 模式用于**像素颜色大面积平坦**的区块

### 2.2 角度模式示意图与角度参数

角度模式编号与其对应的角度模式方向关系如下图（图截自[维基百科](https://zh.wikipedia.org/wiki/%E5%B9%80%E5%85%A7%E7%B7%A8%E7%A2%BC)）

![帧内编码模式_1711](markdown_images/%E5%B8%A7%E5%86%85%E7%BC%96%E7%A0%81%E6%A8%A1%E5%BC%8F_1711.png)

由图可见，角度模式编号**按顺时针方向增加**，**越靠近垂直和水平方向越密**，其精度为 $\frac{1}{32}$，值得注意的两个模式是 **10 模式（水平模式）**和 **26 模式（垂直模式），角度方向**的定义为**以蓝色小矩形为起点矩形中点为终点的有向线段的方向**

不同的角度模式有不同的**角度参数 A**（就是图上 V 和 H 加减的那个数），其与模式之间的关系表格如下（图截自英文书）

![帧内编码模式_5114](markdown_images/%E5%B8%A7%E5%86%85%E7%BC%96%E7%A0%81%E6%A8%A1%E5%BC%8F_5114.png)

这个角度参数 A 在后面进行参考像素投影时有用

### 2.3 帧内预测模式效果展示

不同帧内预测模式直观效果展示如下（图截自英文书）

![帧内编码模式_8069](markdown_images/%E5%B8%A7%E5%86%85%E7%BC%96%E7%A0%81%E6%A8%A1%E5%BC%8F_8069.png)

此图可以结合之后的章节理解，就概述而言，DC 模式是取**所有像素的平均值**作为待预测区域所有点共同的像素值，Planar 模式类似于**取水平和垂直参考像素点的平均**形成待预测点的像素值，最后的角度模式则是当角度参数 A 为正时**取上侧或左侧像素为参考**得到预测结果，当角度参数 A 为负时**同时取上侧和左侧像素为参考**得到预测结果

## 3 色度分量的帧内编码模式

### 3.1 帧内编码模式简介

HEVC 中色度分量有五种预测模式，分别为 **Planar 模式**（模式 0）、**DC 模式**（模式 1）、**水平模式**（模式 10）、**垂直模式**（模式 26）和**推断模式**（Derive Mode，在 HM 程序里是模式 36），前四种与亮度分量中使用的对应模式相同，最后一种含义为**使用该色度区块对应的亮度区块的预测模式作为此色度区块的预测模式**

### 3.2 模式 34

色度 PB 区块的预测模式存在一个比较奇怪的机制，当其对应的亮度区块使用的预测模式也为 0/1/10/26 模式中的一种时，**色度 PB 区块对应模式将被替换为模式 34**，也就是如果亮度区块所使用的预测模式为水平模式（模式 10），那么现在的色度 PB 区块的五种预测模式则会变为 Planar 模式（模式 0）、DC 模式（模式 1）、**V+32 模式**（模式 34）、垂直模式（模式 26）和推断模式（Derive Mode，在 HM 程序里是模式 36），由于在选择最优模式时会计算所有 5 个模式的率失真，这种改变可以让模式 10 不会被计算两次，但是看代码似乎会把模式 34 也纳入率失真计算，而非对其跳过，这一点就比较奇怪，因为这个 34 应该只是个例外的标记，而非真的表示 V+32 模式

不同情况下色度分量的预测模式示意图（图截自英文书）

![帧内编码模式_5517](markdown_images/%E5%B8%A7%E5%86%85%E7%BC%96%E7%A0%81%E6%A8%A1%E5%BC%8F_5517.png)

> 根据老师所言，模式 34 好像确实是会参与计算，不仅仅是作为标记而存在，这个可能要查文档

### 3.3 相关代码

色度编码模式默认的排列序列 `uiModeList` 由 **`TComDataCU::getAllowedChromaDir`** 函数生成，其逻辑如下

1. 如果**亮度 PB 的预测模式不为 0，1，10，26 之一**，那么 `uiModeList` 为

    ```cpp
      uiModeList[0] = PLANAR_IDX;
      uiModeList[1] = VER_IDX;
      uiModeList[2] = HOR_IDX;
      uiModeList[3] = DC_IDX;
      uiModeList[4] = DM_CHROMA_IDX;
    ```

2. 如果**亮度 PB 的预测模式为这四种模式之一**，那么将在上式的基础上，执行以下代码，把 `uiModeList` 中**等于亮度 PB 预测模式的那个值**换成 34

    ```cpp
    for( Int i = 0; i < NUM_CHROMA_MODE - 1; i++ )
      {
        if( uiLumaMode == uiModeList[i] )
        {
          uiModeList[i] = 34; // VER+8 mode
          break;
        }
      }
    ```