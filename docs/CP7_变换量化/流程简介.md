# 流程简介

## 1 简介

### 1.1 概述

变换与量化是 HEVC 中**变换编码**的体现，其为一个**有损压缩**过程。变换步骤以 **DCT** 为变换形式，将时域残差变换至频域，量化步骤将**量化步长**范围内的所有值量化为一个值，通过对量化步长的调整，可以对视频的码率（压缩率）与画质进行选择。

> 量化步长越大，则码率减小（压缩率提高），但画质损失，量化步长越小，则码率增大（压缩率减小），但画质保留

HEVC 规定了反量化和反 DCT 变换的操作，而 DCT 正变换和量化操作本身由编码端自由选择

### 1.2 变换与量化总过程

变换与量化总过程： 残差 → DCT 正变换（得到 $coff$）→ 量化（得到 $level$）→ 反量化（得到 $coff_Q$）→ DCT 反变换 → 复原的残差

其示意图如下

![流程简介_2676](markdown_images/%E6%B5%81%E7%A8%8B%E7%AE%80%E4%BB%8B_2676.png)

其中 U 为**残差**，$Q_{step}$ 为**量化步长**，C 为**变换矩阵**（DCT 的正反变换可以等价于输入残差矩阵乘以一个变换矩阵），正变换的矩阵和反变换的矩阵**互为转置**

## 2 加入 Scaling 操作后的流程

### 2.1 概述

在 HEVC 中，所有的计算以整数进行，因此为了保证精度，在变换与量化中首先会将操作数按 2 的幂次倍扩大，然后进行预期的计算，这就意味着计算的结果与原结果相差了 2 的幂次个数量级。Scaling 操作的目的是平衡这种影响，**通过乘以 Scaling 系数将计算结果的数量级修正**。

在 HEVC 中需要进行六次会导致计算结果数量级增大的操作，分别为 2 次 DCT（一次二维 DCT 可以被分为两次一维 DCT）、1 次量化、1 次反量化以及 2 次反 DCT，在 HEVC 中同样设置了**六次**对应位置的 Scaling 操作，其 Scaling 系数分别为 $S_{T1},S_{T2},S_Q,S_{IQ},S_{IT1},S_{IT2}$。

> 在之前的帧内帧间预测的公式中，也有这个现象，但是 Scaling 操作本身也包含在了公式中，只需要进行一次，所以它除的数是确定的，不需要有什么花里胡哨的操作，但是这里 Scaling 操作会进行六次，只要合起来能正好抵消数量级扩大的影响就行，那就可以有很多操作空间了

### 2.2 流程图

加入 Scaling 操作后的流程图如下

![流程简介_4540](markdown_images/%E6%B5%81%E7%A8%8B%E7%AE%80%E4%BB%8B_4540.png)

### 2.3 Scaling 参数的选择

在进行一维 DCT 变换/反变换时，会乘以大小为 $2^{(6+M/2)}$ 的缩放系数（$M=log_2{N}$，N 为区块的边长），在进行量化操作时，会乘以大小为 $2^{14}$ 的缩放系数，在进行反量化操作时，会乘以大小为 $2^6$ （反量化）和 $2^4$（量化矩阵）的缩放系数，**DCT 变换部分使数量级扩大了 $\bf 2^{24+2M}$ 倍，量化部分使数量级扩大了 $\bf 2^{24}$ 倍**，因此所有的 Scaling 系数乘起来应该需要抵消掉这部分影响

经过一些权衡之后，最终得到的 Scaling 参数如下所示（B 是输入视频的**比特深度**（也就是用多少比特表示输入视频的一个颜色分量），一般为 8 或 10）

- $S_{TI}=2^{-(B+M-9)}$
- $S_{T2}=2^{-(M+6)}$
- $S_Q=2^{-(29-M-B)}$
- $S_{IT1}=2^{-7}$
- $S_{IT2}=2^{-(20-B)}$
- $S_{IQ}=2^{-(M-5+B)}$

加起来一共 $2^{-(48+2M)}$，符合要求