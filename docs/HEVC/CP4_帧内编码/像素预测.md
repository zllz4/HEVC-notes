# 像素预测

## 1 像素预测规则

### 1.1 概述

像素预测是帧内编码中的最关键环节，通过已经取得的参考像素预测待预测 TU 中的像素值。角度模式、DC 模式以及 Planar 模式分别有不同的预测规则。

### 1.2 角度模式

角度模式的像素预测规则如下

![像素预测_4792916992](markdown_images/%E5%83%8F%E7%B4%A0%E9%A2%84%E6%B5%8B_4792916992.png)

图中 4.12 和 4.13 是像素预测的关键公式，其意义为将当前待预测像素点 $p[x][y]$ 以 $\frac{1}{32}$ 的精度按照角度预测方向投影在参考像素序列上（就是 [参考像素投影] 章节中的那个 ref 序列），然后将投影位置的 ref 序列上点的像素值作为待预测像素点的像素值。**如果投影点在 ref 序列上的坐标为整数 n，那么就以 $ref[n]$ 的值作为待预测像素点的值，如果投影点在 ref 序列上的坐标为小数 $n+\frac{f}{32}$，那么就以 $ref[n]$ 和 $ref[n+1]$ 的插值作为待预测像素点的值，这个插值的公式就是 $\frac{32-f}{32}ref[n]+\frac{f}{32}ref[n+1]$**

公式 4.14-4.17 用于计算投影点在 ref 序列上坐标的**整数偏移 i 和小数部分 f**，其中关键的部分是 $(y+1)*A$（以垂直模式为例），**A 为角度参数**，这部分可以依照如下图示进行理解

![像素预测_792788992](markdown_images/%E5%83%8F%E7%B4%A0%E9%A2%84%E6%B5%8B_792788992.png)

首先，我们有一个待预测点 P，其坐标为 $(x,y)$，由于我们选择了垂直的角度模式，因此参考序列是一个水平的序列，以 A 点为 $ref[0]$，即零点。B 点是点 P 的垂直投影，其在 ref 序列上的索引为 $ref[x+1]$，C 点是 P 点的水平投影，其与 A 点的距离为 $y+1$

假设我们采用的是垂直预测模式 26，那么 B 点就是待预测点 P 的参考点，如果我们采用的是其它的垂直预测模式，由于角度参数 A 不为零，我们需要按照角度预测方向将 P 点投影到 ref 序列中，此时 P 点的投影将会偏离 B 点，偏离的程度可以按照小学二年级学会的相似三角形定理计算

![像素预测_6793781248](markdown_images/%E5%83%8F%E7%B4%A0%E9%A2%84%E6%B5%8B_6793781248.png)

图就不解释了，按照这个相似定理我们可以算出**偏离的程度** $O$ **为** $\frac{y+1}{32}A$，这个偏离的程度是一个实数，因此可以分成**整数部分** $i=(y+1)A/32$ 和**以** $\frac{1}{32}$ **精度表示的小数部分** $f=(y+1)A\%32$（就是一单位 f 代表 $\frac{1}{32}$），偏移  $O\approx i+\frac{f}{32}$，最后我们得到的像素点 P 在 ref 序列上的投影点的坐标为 $ref[x+1+O]=ref[1+x+i+\frac{f}{32}]$

需要注意，**A 有符号**，当 $(x+1)*A$ 为正时，$i$ 是正的且移位操作属于往下取整，$f$ 是正的，当 $(x+1)*A$ 为负时，$i$ 是负的且移位操作依旧属于往下取整，$f$ 也是正的，不论任何时刻，均有 $x+1+i<x+1+i+\frac{f}{32}<x+2+i$，即投影点是在 $ref[x+1+i]$ 和 $ref[x+2+i]$ 之间的，且距离 $ref[x+1+i]$ 这个点正好 $\frac{f}{32}$ 的距离。因此按照之前的分析，**我们可以把** $x+1+i$ **视为 n，把** $f$ **视为前面的** $f$，按照插值公式计算 $\frac{32-f}{32}ref[n]+\frac{f}{32}ref[n+1]$，四舍五入，就是公式 4.13 的结果。

### 1.3 DC 模式

DC 模式像素预测值为**左侧和上方（不包括左下、左上和右上）所有参考像素的均值**

![像素预测_1835992064](markdown_images/%E5%83%8F%E7%B4%A0%E9%A2%84%E6%B5%8B_1835992064.png)

### 1.3 Planar 模式

Planar 模式的预测结果就是像素的垂直方向预测值 $p_v$ 与像素水平方向预测值 $p_h$ 的平均，公式如下

![像素预测_156845056](markdown_images/%E5%83%8F%E7%B4%A0%E9%A2%84%E6%B5%8B_156845056.png)

$p_v$ 和 $p_h$ 为下图 A B 两个点的**线性插值**，$p_{v}/p_{h}=d_{BP}A+d_{AP}B$（本来要除以 N 的但是这个在公式 4.18 里面除了）

![像素预测_7655854080](markdown_images/%E5%83%8F%E7%B4%A0%E9%A2%84%E6%B5%8B_7655854080.png)