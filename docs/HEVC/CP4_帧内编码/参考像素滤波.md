# 参考像素滤波

## 1 像素滤波规则

### 1.1 概述

参考像素滤波是参考像素获取的**第二步**，滤波操作的主要目的是为了 "**avoiding steps in the values of reference samples that could potentially generate unwanted directional edges to the prediction block**"（这句话不太清楚怎么很好地翻译），**待预测 TU 区块大小和所选取的预测模式**决定了参考像素滤波是否开启

### 1.2 开启规则与滤波模式

决定参考像素滤波是否开启的具体规则如下

1. 若待预测的 TU 区块为 4x4 大小或者帧内预测模式为 DC 模式，则不滤波
2. 若待预测的 TU 区块为 8x8 大小，则只有当帧内预测模式为角度模式 2，18 和 34 时才滤波（这三个都是斜对角）
3. 若待预测的 TU 区块为 16x16 大小，则只有当帧内预测模式为角度模式 9-11 和 25-27 时才不滤波（很接近水平或者垂直的模式）
4. 若待预测的 TU 区块为 32x32 大小，则只有当帧内预测模式为角度模式 10 和 26 时才**不**滤波（水平和垂直模式）

若决定滤波开启，之后则需要确定所采用的滤波模式。参考像素滤波有两种模式，分别为**默认模式**和**强滤波模式**，当 **TU 为 32x32 大小且参考像素变化足够平坦且 SPS 中的 `strong_intra_smoothing_enabled_flag` 开关打开**时使用强滤波，否则为默认滤波。不同滤波模式可以理解为对参考像素的不同的平滑策略，**默认模式使参考像素轻微平滑，强滤波模式使参考像素极大平滑**

### 1.3 默认滤波

默认滤波的滤波规则如下

![参考像素滤波_2696189952](markdown_images/%E5%8F%82%E8%80%83%E5%83%8F%E7%B4%A0%E6%BB%A4%E6%B3%A2_2696189952.png)

滤波采用 **[1 2 1]/4 滤波器**，图中的 p 点就是上一章 [参考像素补全] 中参考像素示意图里面的 p 点。所谓 [1 2 1]/4 滤波器是指，如果当前点为待预测 TU 上侧的参考像素，设当前点为 b，当前点左边相邻点为 a，当前点右边相邻点为 c，则点 b 滤波后的值为 $\frac{1}{4}(a+2b+c)+\frac{1}{2}$ 向下取整，后面的 $\frac{1}{2}$ 即图中公式里的加上的 2，其目的为四舍五入。如果当前点是位于 TU 左侧的参考像素，则 a c 为当前点上下的相邻点，滤波公式同上。如果当前点位于 TU 左上侧，正好为 $p[-1][-1]$，则 a c 分别为当前点右侧相邻点 $p[0][-1]$ 和下侧相邻点 $p[-1][0]$，如果当前点为最左下点 $p[-1][2N-1]$ 或者最右上点 $p[2N-1][-1]$，则不进行滤波（这里有疑义，英文书说 not modified，中文书说用 [1 3]/4 的滤波器滤波，不知道哪个是对的）

### 1.4 强滤波

强滤波**只使用左上、右上和左下三个点通过线性插值计算其它所有参考点的坐标**，因此能够极大地平滑参考像素，其规则如下

![参考像素滤波_782402560](markdown_images/%E5%8F%82%E8%80%83%E5%83%8F%E7%B4%A0%E6%BB%A4%E6%B3%A2_782402560.png)

![参考像素滤波_1828267008](markdown_images/%E5%8F%82%E8%80%83%E5%83%8F%E7%B4%A0%E6%BB%A4%E6%B3%A2_1828267008.png)

图中不等式 4.4 和不等式 4.5 为强滤波的条件，就是对下图的 CBA 和 CDE 求一个类似**二阶导**的东西，如果这个二阶导小于某阈值，那么就说明参考像素足够平坦，可以进行强滤波（当然还要满足其它两个条件）。公式中的 $b$  是**输入视频的数据位数**，对于 8bit 输入视频来说，计算出的阈值是 8，对于 10bit 输入视频来说，计算出的阈值是 32

![参考像素滤波_536553472](markdown_images/%E5%8F%82%E8%80%83%E5%83%8F%E7%B4%A0%E6%BB%A4%E6%B3%A2_536553472.png)

式 4.6 和 4.7 为强滤波的规则，本质上是一个**线性插值**，比如点 $p[-1][y]$ 离 C 点距离为 $d_c=y+1$，离 A 点距离为 $d_A=63-y$（因为强滤波只能用在 32x32 的 TU 上，所以 B 和 C 的距离是 32，A 和 B 的距离也是 32，A 和 C 的距离是 64），那么这个点的值就由 $\frac{d_A}{64}C+\frac{d_C}{64}A+\frac{1}{2}$ 向下取整替代

## 2 补充笔记

### 2.1 两种滤波的比较示意图

下图为两种滤波的比较

![参考像素滤波_1276034048](markdown_images/%E5%8F%82%E8%80%83%E5%83%8F%E7%B4%A0%E6%BB%A4%E6%B3%A2_1276034048.png)

### 2.2 QA

Q：为什么滤波不对 DC 模式使用？

A：因为滤波的 smoothing 效果对 DC 模式而言基本没有作用