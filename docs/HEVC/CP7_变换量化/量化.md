# 量化

## 1 简介

HEVC 的量化操作的目的是**对变换得到的 DCT 系数进行有损压缩**，量化后的 DCT 系数能够使用更少的比特数进行表示。

HEVC 的量化操作有两个参数，一个是量化参数 $QP$，一个是量化步长 $Q_{step}$，$QP$  **决定** $Q_{step}$，$Q_{step}$ **用于最终量化操作**

就概述而言，量化操作的过程就是原数值除以 $Q_{step}$ 然后进行四舍五入，反量化就是解码得到的值乘以 $Q_{step}$

> 实际上之前的很多舍入操作也是量化，只不过量化步长是 1，这里的量化与舍入的量化的区别可能就是量化的步长会大于 1，最大是  $2^{47/6}\approx228$ ？（$2^{\frac{1}{6}(QP-4)}$，$QP$ 最大 51，再加 1 量化步长就变 256 了）

## 2 量化操作

首先按照以下公式根据 $QP$ 计算出 $Q_{step}$，$QP$ 的**取值范围是 0~51**（对于 8bit 输入的情况），$QP$ 每增加 6 则 $Q_{step}$ 提高一倍

![量化_7439954944](markdown_images/%E9%87%8F%E5%8C%96_7439954944.png)

为了计算方便，上式可以写成下面这种形式

![量化_4614144](markdown_images/%E9%87%8F%E5%8C%96_4614144.png)

![量化_7993380864](markdown_images/%E9%87%8F%E5%8C%96_7993380864.png)

我们可以大致理解为，$G_{QP\%6}$ 是这个幂函数里面的**小数指数部分**，而 $\frac{QP}{6}$ 是这个幂函数里面的**整数指数部分**，类似于将 $10^{\frac{50}{3}}$ 写成 $10^{\frac{2}{3}}\times10^{16}$，这里将 $2^{1/6(QP-4)}$ 写成 $2^{(-4/6+(QP\%6)/6)}\times2^{\lfloor QP/6 \rfloor}$，这个小数指数部分的范围在 $[0.6299,\ 1.1225]$ 之间，一共有 6 种取值

> 由于它是拿 QP 去分割整数小数而不是拿 QP-4 去分割的，所以这个小数部分会小于 1，如果按照 QP-4 来分，那么这个小数指数的范围应该在 $[2^0,\ 2^1]$ 也就是 $[1,\ 2]$ 之间 ，但性质是类似的

或者可以把这种表示理解成一种以 2 的幂次为指数部分的**科学计数法**，G 为其**有效数**部分，$\frac{QP}{6}$ 为其**幂指数**部分

由于 HEVC 仅支持整数计算，需要在计算前先**乘以一个缩放因子**，对于量化操作，由于要除以 $G$，所以是 $\bf \frac{1}{G}$ **乘以缩放因子** $\bf 2^{14}$，缩放结果称为 $\bf f$，对于反量化操作，由于要乘以 $G$，所以是 $\bf G$ **乘以缩放因子** $\bf 2^6$，缩放结果称为 $\bf g$，$f$ 和 $g$ 的具体值如下

![量化_5842482176](markdown_images/%E9%87%8F%E5%8C%96_5842482176.png)

![量化_3228815360](markdown_images/%E9%87%8F%E5%8C%96_3228815360.png)

![量化_6741688320](markdown_images/%E9%87%8F%E5%8C%96_6741688320.png)

之后需要设置**量化矩阵** $\bf W[x][y]$，量化矩阵的功能是**对 TU 不同位置的 DCT 系数值施加不同的量化参数（量化步长）**，其作用形式是量化时 DCT 系数是**先除以量化矩阵的里面的权重**再执行量化，反量化时量化值同样要**先乘以量化矩阵里面的权重**再执行反量化

当不需要量化矩阵时，$W[x][y]$ 被设置为 1，为了保证精度，**对量化矩阵中的权重乘以 $16$ 之后应用到实际计算**，此时量化权重用 $w[x][y]$ 表示

![量化_3399101440](markdown_images/%E9%87%8F%E5%8C%96_3399101440.png)

量化矩阵的权重值计算完成之后，可以进行量化与反量化的最终操作计算，量化操作计算公式如下

![量化_303356928](markdown_images/%E9%87%8F%E5%8C%96_303356928.png)

其中 $level[x][y]$ 是最终位于坐标 $(x,y)$ 的量化结果，$coeff[x][y]$ 是位于坐标 $(x,y)$ 的 DCT 变换系数，$offset_Q$ 是用来进行四舍五入的偏移量，$shift2$ 代表了 [流程简介] 中提到的 Scaling 参数 $S_Q$，由于$S_Q=2^{-(29-M-B)}$，所以 $shift2=29-M-B$，其它参数与前文介绍中提到的相同

> 注意如式 6.10 的量化操作只是一种选择，HEVC 没有规定量化操作，HM 模型就采用了一个基于率失真优化（rate-distortion optimized quantization (RDOQ)）的量化策略

反量化操作计算公式如下

![量化_4589499392](markdown_images/%E9%87%8F%E5%8C%96_4589499392.png)

其中 $shift1$ 代表 [流程简介] 中提到的 $S_{IQ}$，其值为 $M-5+B$

## 3 量化矩阵

### 3.1 简介

HEVC 的量化有两种模式，一种是**频率依赖的量化**（frequency dependent scaling），一种是**频率独立的量化**（frequency independent scaling），前者会启用量化矩阵，后者不会启用量化矩阵。

频率依赖的量化可以针对人的视觉做出优化，实现**基于人视觉系统的量化**（human visual system (HVS) - based quantization），**在低频区采用较少的量化步长，在高频区采用较大的量化步长**

关于量化矩阵的一些介绍可以看[此 csdn 文章](https://blog.csdn.net/lin453701006/article/details/102723649)

### 3.2 量化矩阵

HEVC 根据 TB 区块大小和类型的不同，有 20 种不同的量化矩阵

![量化_7283307520](markdown_images/%E9%87%8F%E5%8C%96_7283307520.png)

HEVC 提供了 **4x4 和 8x8 大小**的量化矩阵的**默认值**，更大的量化矩阵的值**由上采样得到**

![量化_5469331456](markdown_images/%E9%87%8F%E5%8C%96_5469331456.png)

下图为上采样规则，感觉就是把一个值复制 4 份或者复制 16 份

![量化_5157794816](markdown_images/%E9%87%8F%E5%8C%96_5157794816.png)

### 3.3 语法元素

量化矩阵的启用由 SPS 中的 `scaling_list_enabled_flag` 确定（量化矩阵在 HEVC 中被称为 `scaling_list`）

`scaling_list` 有**关闭**、**默认**和**自定义**三种模式，默认模式使用上述 HEVC 中提供的量化矩阵默认值，自定义模式使用自定义的量化矩阵值，三种模式的定义代码如下

```cpp
enum ScalingListMode
{
  SCALING_LIST_OFF,
  SCALING_LIST_DEFAULT,
  SCALING_LIST_FILE_READ
};
```

## 4 QP 推断

### 4.1 概述

在 HEVC 中 $QP$ 使用**预测编码**，传输的是 $\Delta QP$，$QP$ 的预测值由左侧、上侧和之前（previous）区块的 $QP$ 值通过某种预测规则得到

$\Delta QP$ 在 quantization group(QG) level 传输，QG 块的大小是 CU 块的倍数，其大小由 CTU 大小和参数 `diff_cu_qp_delta_depth` 指定，表格如下

![量化_390196224](markdown_images/%E9%87%8F%E5%8C%96_390196224.png)

HEVC 允许**同一张图片的不同部分使用不同的 QP 值**（用于码率控制或者基于感知的量化）

### 4.2 QP 推断步骤

QP 预测使用左侧、上侧和先前（这个先前 QP 应该是先前解码的那个 QP，而不是什么同位图片上的 QP）的值预测当前 QP 的值，用于计算 delta QP，其计算状态图如下，当 $QP_{above}$ 或者 $QP_{left}$ 在不同的 CTU 时被视为不可用，当 the current QG is at a slice/tile/picture boundary 时同样如此，在 slice、tile 和 picture boundary 开头 $QP_{prev}$ 将被初始化为 slice 的 QP 值

![量化_1235492864](markdown_images/%E9%87%8F%E5%8C%96_1235492864.png)

以上推断出的是亮度分量的 QP 值，至于色度分量的两个 QP 值则由亮度分量的 QP 值通过某种规则推断得出（可能是通过补充笔记里面的那个表？）

## 5 补充笔记

### 5.1 亮度 QP 与色度 QP

亮度 QP 与色度 QP 的关系如下图 

![量化_3231238144](markdown_images/%E9%87%8F%E5%8C%96_3231238144.png)

### 5.2 ΔQP 的传输

$\Delta QP$ 只在**残差非零**的 CU 上传输，其具体规则如下

![量化_6195381248](markdown_images/%E9%87%8F%E5%8C%96_6195381248.png)

> 这里比较奇怪的一点是，之前英文书提到 QG 块大小是 CU 块大小的整数倍，这里又提到有可能 CU 块比 QG 块大，到底谁比谁大？