# 亚精度像素插值

## 1 概述

亚精度插值是运动补偿的第一个操作，由于运动向量可能非整，因此非整数坐标的像素值也可被用于像素预测，**通过整数位置上的像素值获取非整数坐标的像素值的做法被称为亚精度插值**，获取二分之一坐标处像素值的做法称之为**半精度插值**，获取四分之一坐标处像素值的做法称为**四分之一精度插值**。**HEVC 最高支持四分之一精度插值（亮度分量）和八分之一精度插值（色度分量）。**

## 2 规则

### 2.1 亚精度插值滤波器

亚精度像素插值实质上是一个**滤波操作**，对**整数位置**上的像素值使用**亚精度插值滤波器**滤波得到非整数位置上的像素值，其数学原理是**根据整数位置的像素值进行 DCT 变换得到 DCT 变换系数，然后由 DCT 变换系数进行 DCT 反变换得到非整数位置的像素值**，这个过程可以等效为一个滤波器，其系数值如下

![亚精度像素插值_62848](markdown_images/%E4%BA%9A%E7%B2%BE%E5%BA%A6%E5%83%8F%E7%B4%A0%E6%8F%92%E5%80%BC_62848.png)

HEVC 亮度 PB 区块的半精度像素插值采用 **8 抽头**滤波器，四分之一精度像素插值采用 **7 抽头**滤波器，色度 PB 区块在所有情况下亚精度插值均采用 **4 抽头**滤波器，**滤波器系数被量化成 6bit 大小**

> 但是看上图虽然滤波器系数的绝对值是小于 $2^6=64$ 的，但是其有正负之分，加上符号位感觉应该是 7bit？为什么书上说是 6bit？

在 HM 程序中，可以通过 **`TComInterpolationFilter::m_lumaFilter`** 以及 **`TComInterpolationFilter::m_chromaFilter`** 数组来找获取这两个系数

```cpp
const TFilterCoeff TComInterpolationFilter::m_lumaFilter[LUMA_INTERPOLATION_FILTER_SUB_SAMPLE_POSITIONS][NTAPS_LUMA] =
{
  {  0, 0,   0, 64,  0,   0, 0,  0 },
  { -1, 4, -10, 58, 17,  -5, 1,  0 },
  { -1, 4, -11, 40, 40, -11, 4, -1 },
  {  0, 1,  -5, 17, 58, -10, 4, -1 }
};

const TFilterCoeff TComInterpolationFilter::m_chromaFilter[CHROMA_INTERPOLATION_FILTER_SUB_SAMPLE_POSITIONS][NTAPS_CHROMA] =
{
  {  0, 64,  0,  0 },
  { -2, 58, 10, -2 },
  { -4, 54, 16, -2 },
  { -6, 46, 28, -4 },
  { -4, 36, 36, -4 },
  { -4, 28, 46, -6 },
  { -2, 16, 54, -4 },
  { -2, 10, 58, -2 }
};
```

### 2.2 亚精度插值方法

#### 2.2.1 亮度分量插值方法

亮度分量插值示意图如下，其中大写字母 A 代表整数位置的像素，小写字母代表需要插值得到的小数位置的像素

![亚精度像素插值_41600](markdown_images/%E4%BA%9A%E7%B2%BE%E5%BA%A6%E5%83%8F%E7%B4%A0%E6%8F%92%E5%80%BC_41600.png)

插值方法就是用 2.1 节提到的插值滤波器进行滤波，具体示例如下图，先对整像素行列进行插值，然后对剩余的亚像素位置进行插值

![亚精度像素插值_27264](markdown_images/%E4%BA%9A%E7%B2%BE%E5%BA%A6%E5%83%8F%E7%B4%A0%E6%8F%92%E5%80%BC_27264.png)

![亚精度像素插值_5952](markdown_images/%E4%BA%9A%E7%B2%BE%E5%BA%A6%E5%83%8F%E7%B4%A0%E6%8F%92%E5%80%BC_5952.png)

#### 2.2.2 色度分量插值方法

![亚精度像素插值_94752](markdown_images/%E4%BA%9A%E7%B2%BE%E5%BA%A6%E5%83%8F%E7%B4%A0%E6%8F%92%E5%80%BC_94752.png)

![亚精度像素插值_48288](markdown_images/%E4%BA%9A%E7%B2%BE%E5%BA%A6%E5%83%8F%E7%B4%A0%E6%8F%92%E5%80%BC_48288.png)

$ad_{0,0}$  使用表中代表 $\frac{3}{8}$ 亚像素位置的滤波器进行插值，基于**水平的四个整数点** $B_{-1,0}$ 到 $B_{2,0}$

$da_{0,0}$ 使用标志代表 $\frac{3}{8}$ 亚像素位置的滤波器进行插值，基于**垂直的四个整数点** $B_{0,-1}$ 到 $B_{0,2}$

$dd_{0,0}$ 使用表中代表 $\frac{3}{8}$ 亚像素位置的滤波器进行插值，基于**垂直的四个亚像素点** $ad_{0,-1}$ 到 $ad_{0,2}$

## 2 补充笔记

### 2.1 插值滤波器需要满足的条件

亮度 PB 区块使用的半精度插值的滤波器需要满足**对称性**，同时**所有滤波系数加起来正好是 1**（这样才能正确对直流情况滤波，也就是如果所有整数位置的像素都是同一个值，那么滤波得到的小数位置上的像素也应该是这个值），四分之一精度滤波器**只需要满足后者**，**不需要对称性**，假设滤波器有 2N 个抽头，那么半精度插值的滤波器的自由度是 N-1，而四分之一精度滤波器的自由度是 2N-1

### 2.2 H.264 和 HEVC 半精度插值滤波器频率响应

H.264 和 HEVC 半精度插值滤波器频率响应比较如下

![亚精度像素插值_96800](markdown_images/%E4%BA%9A%E7%B2%BE%E5%BA%A6%E5%83%8F%E7%B4%A0%E6%8F%92%E5%80%BC_96800.png)

由图可见 HEVC 半精度插值滤波器的频率响应更加接近理想值

### 2.3 H.264 和 HEVC 在亚精度插值和像素值预测中的区别

#### 2.2.1 区别一

H.264 亮度 PB 区块（可能是）的半精度像素插值采用 **6 抽头**滤波器，而四分之一精度像素值采用**两点内插**，即插值操作**由整数位置像素值得到半精度位置像素值，由平均操作从半精度像素值得到四分之一精度位置像素值**，HEVC 则**直接由滤波器从整数位置像素值得到四分之一精度位置像素值**

H.264 采用的**链式依赖的滤波操作**（cascaded filtering process）可能会出现**误差叠加**的问题，比如依靠半精度位置像素值获取四分之一精度位置像素值，由于半精度位置的像素值在求值时经过了 round 操作，因此产生了误差，这个有误差的值再被用于四分之一精度位置像素值的计算，就会造成误差增大

#### 2.2.2 区别二

H.264 在执行帧间预测时若**当前 PB 区块为双向预测模式**且**一个或多个 MV 非整**，则先**对参考图像进行插值**，之后**将插值舍入**（round）**至输入视频的像素深度**（一般为 8bit/10bit），最后**将两个参考区块**（参考区块指当前 PB 通过 MV 反向位移得到的参考图像上的对应区块，注意这个区块里的像素点的坐标可能是非整的）**上的值求平均**，最后**再进行一个舍入操作**得到当前 PB 区块的预测像素值（MCP）。HEVC 则**在插值后不会进行舍入操作**，而是保持精度进行平均运算，一个特殊情况是一个 MV 只含有整数值而另一个 MV 含有非整数值，此时 HEVC 会将含有整数值的 MV 对应的参考图像上的整数位置像素进行精度提升，保证其与非整数 MV 参考图像上像素插值后的像素深度相同。两者示意图如下

![亚精度像素插值_84800](markdown_images/%E4%BA%9A%E7%B2%BE%E5%BA%A6%E5%83%8F%E7%B4%A0%E6%8F%92%E5%80%BC_84800.png)

以上两个区别有助于 HEVC 相比 H.264 获得更高的预测精度
