# 加权像素预测

## 1 概述

**加权像素预测**（Weighted Prediction，WP）是帧内预测的最后一个步骤，其主要用于处理视频中**由于光线明暗变化造成的像素值的整体性的渐变**

以下为对加权像素预测的介绍，图片截自[此地址](https://blog.csdn.net/linpengbin/article/details/49497287)

![加权像素预测_8534154240](markdown_images/%E5%8A%A0%E6%9D%83%E5%83%8F%E7%B4%A0%E9%A2%84%E6%B5%8B_8534154240.png)

加权像素预测可在 **PPS 层次**上开关控制，在 PPS 中有 `weighted_pred_flag` 参数和 `weighted_bipred_flag` 参数标记不同的情况

## 2 规则

**单向预测**时 WP 操作公式如下

![加权像素预测_6720680960](markdown_images/%E5%8A%A0%E6%9D%83%E5%83%8F%E7%B4%A0%E9%A2%84%E6%B5%8B_6720680960.png)

$P_{L0}[x][y]$ 为当前帧内预测区域中位于坐标 $(x,y)$ 的像素预测值，$w_0$ 和 $o_0$ 为标量，表示 WP 操作中的**权重**（weight）**和偏置**（offset）

**双向预测**时 WP 操作公式如下

![加权像素预测_7402692608](markdown_images/%E5%8A%A0%E6%9D%83%E5%83%8F%E7%B4%A0%E9%A2%84%E6%B5%8B_7402692608.png)

$P_{L0}[x][y]$ 和 $P_{L1}[x][y]$ 为当前帧内预测区域中位于坐标 $(x,y)$ 的像素预测值，**由于双向预测有两组运动信息**（分别对应参考序列 0 和参考序列 1）**，因此有两个预测值**。$w_0,o_0,w_1,o_1$ 分别为对应的权重和偏置，在 HEVC 中这些参数需要**显式地指定**。当 $w_0=w_1$ 且 $o_0=o_1$ 时，类似于先对两个预测值取平均，然后进行 WP 操作

LWD（log weight denominator）主要用于舍入操作